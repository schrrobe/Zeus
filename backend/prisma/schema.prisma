generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  ADMIN
  ACCOUNTING
  MEMBER
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  VOID
  OVERDUE
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
}

enum InvoiceType {
  INVOICE
  CREDIT_NOTE
}

enum PermissionLevel {
  NONE
  READ
  WRITE
}

enum FileType {
  PDF
  E_INVOICE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
}

model Organization {
  id                String                 @id @default(uuid())
  name              String
  slug              String                 @unique
  plan              String                 @default("free")
  createdAt         DateTime               @default(now())
  users             Membership[]
  customers         Customer[]
  items             Item[]
  invoices          Invoice[]
  quotes            Quote[]
  taxRates          TaxRate[]
  theme             ThemeSetting?
  invoiceMeta       InvoiceMeta?
  invoiceCounter    InvoiceCounter?
  invoiceNumbering  InvoiceNumbering?
  invites           Invite[]
  subscriptions     Subscription[]
  auditLogs         AuditLog[]
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  displayName   String
  passwordHash  String
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  memberships   Membership[]
  notes         CustomerNote[]
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]
}

model Membership {
  id              String       @id @default(uuid())
  role            Role
  organizationId  String
  userId          String
  isActive        Boolean      @default(true)
  organization    Organization @relation(fields: [organizationId], references: [id])
  user            User         @relation(fields: [userId], references: [id])
  permissions     Permission[]

  @@unique([organizationId, userId])
}

model Permission {
  id            String           @id @default(uuid())
  featureKey    String
  level         PermissionLevel
  membershipId  String
  membership    Membership @relation(fields: [membershipId], references: [id])

  @@unique([membershipId, featureKey])
}

model Invite {
  id             String       @id @default(uuid())
  organizationId String
  email          String
  role           Role
  token          String       @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model Customer {
  id             String         @id @default(uuid())
  organizationId String
  name           String
  email          String?
  address        String?
  contactPerson  String?
  phone          String?
  createdAt      DateTime       @default(now())
  organization   Organization   @relation(fields: [organizationId], references: [id])
  invoices       Invoice[]
  quotes         Quote[]
  notes          CustomerNote[]
}

model CustomerNote {
  id         String   @id @default(uuid())
  content    String
  createdAt  DateTime @default(now())
  customerId String
  authorId   String
  customer   Customer @relation(fields: [customerId], references: [id])
  author     User     @relation(fields: [authorId], references: [id])
}

model Item {
  id             String       @id @default(uuid())
  organizationId String
  name           String
  description    String?
  priceCents     Int
  unit           String
  taxRateId      String?
  organization   Organization @relation(fields: [organizationId], references: [id])
  taxRate        TaxRate?     @relation(fields: [taxRateId], references: [id])
  createdAt      DateTime     @default(now())
}

model TaxRate {
  id             String       @id @default(uuid())
  organizationId String
  name           String
  percentage     Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  items          Item[]
  invoices       Invoice[]
  quotes         Quote[]
  createdAt      DateTime     @default(now())
}

model Quote {
  id             String       @id @default(uuid())
  organizationId String
  customerId     String
  status         QuoteStatus  @default(DRAFT)
  issuedAt       DateTime?
  validUntil     DateTime?
  totalCents     Int          @default(0)
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
  customer       Customer     @relation(fields: [customerId], references: [id])
  taxRateId      String?
  taxRate        TaxRate?     @relation(fields: [taxRateId], references: [id])
  lines          QuoteLine[]
}

model QuoteLine {
  id          String   @id @default(uuid())
  quoteId     String
  description String
  quantity    Int
  unitPrice   Int
  taxRateId   String?
  quote       Quote    @relation(fields: [quoteId], references: [id])
  taxRate     TaxRate? @relation(fields: [taxRateId], references: [id])
}

model Invoice {
  id             String        @id @default(uuid())
  organizationId String
  customerId     String
  number         Int?
  numberYear     Int?
  type           InvoiceType
  status         InvoiceStatus @default(DRAFT)
  issuedAt       DateTime?
  dueAt          DateTime?
  totalCents     Int           @default(0)
  subtotalCents  Int           @default(0)
  taxCents       Int           @default(0)
  discountCents  Int           @default(0)
  taxRateId      String?
  headerText     String?
  footerText     String?
  createdAt      DateTime      @default(now())
  organization   Organization  @relation(fields: [organizationId], references: [id])
  customer       Customer      @relation(fields: [customerId], references: [id])
  taxRate        TaxRate?      @relation(fields: [taxRateId], references: [id])
  lines          InvoiceLine[]
  payments       Payment[]
  files          FileRecord[]
  auditLogs      AuditLog[]

  @@unique([organizationId, numberYear, number])
}

model InvoiceLine {
  id           String   @id @default(uuid())
  invoiceId    String
  description  String
  quantity     Int
  unitPrice    Int
  taxRateId    String?
  lineTotal    Int
  invoice      Invoice  @relation(fields: [invoiceId], references: [id])
  taxRate      TaxRate? @relation(fields: [taxRateId], references: [id])
}

model Payment {
  id          String   @id @default(uuid())
  invoiceId   String
  amountCents Int
  paidAt      DateTime @default(now())
  method      String
  reference   String?
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
}

model FileRecord {
  id          String   @id @default(uuid())
  invoiceId   String
  type        FileType
  path        String
  mimeType    String
  createdAt   DateTime @default(now())
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
}

model ThemeSetting {
  id             String       @id @default(uuid())
  organizationId String       @unique
  spacingX       String
  spacingY       String
  fontHeading    String
  fontBody       String
  brand50        String
  brand100       String
  brand500       String
  brand700       String
  mode           String
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model InvoiceMeta {
  id             String       @id @default(uuid())
  organizationId String       @unique
  headerText     String
  footerText     String
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model InvoiceCounter {
  id             String       @id @default(uuid())
  organizationId String       @unique
  currentNumber  Int          @default(1000)
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model InvoiceNumbering {
  id             String       @id @default(uuid())
  organizationId String       @unique
  prefix         String       @default("INV")
  nextNumber     Int          @default(1000)
  resetYearly    Boolean      @default(true)
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model Subscription {
  id                     String             @id @default(uuid())
  organizationId         String
  provider               String
  providerCustomerId     String
  providerSubscriptionId String
  status                 SubscriptionStatus
  plan                   String
  currentPeriodEnd       DateTime?
  createdAt              DateTime           @default(now())
  organization           Organization       @relation(fields: [organizationId], references: [id])
}

model AuditLog {
  id             String       @id @default(uuid())
  organizationId String
  userId         String
  action         String
  entityType     String
  entityId       String?
  metadata       Json?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}
